# Commercial Loan Referral Platform (V1)

A full-stack implementation of the **AI Engineering Challenge v4** using:

- Backend: `FastAPI + SQLModel + Alembic + SQLite`
- Frontend: `React + Vite + MUI + dnd-kit`
- Deployment target: `EC2 (backend)` + `Vercel (frontend)`

## What is Implemented

### Roles and Portals
- `partner`: signup/login, submit deals, dashboard metrics, deal list/detail, commission summary, resources hub
- `borrower`: invite acceptance, login, view-only dashboard with loan status list
- `admin`: kanban pipeline, stage/sub-stage actions, partner management, lender import/filter, commission lifecycle, CSV exports

### Core Flows
- Partner submits deal (optional file upload)
- Borrower account auto-created/reused by email with invite token flow
- Admin sees deal in Kanban and can move stages / set substages / assign lender / decline with reason
- Admin creates and updates commission (`pending -> earned -> paid` forward-only)
- Partner sees commission summary and deal status updates
- Admin downloads separate CSV exports for deals, partners, borrowers, commissions

## Project Structure

```text
backend/
  app/core/                     # config, db, security, logging
  app/common/                   # shared exceptions and helpers
  app/modules/<module>/         # each module has models/schemas/router/service/repository/deps/validators
  alembic/                      # migration environment + initial revision
  tests/

frontend/
  src/app/                      # router, auth provider, theme, guards
  src/shared/                   # API client, shell, shared types
  src/modules/<module>/         # each module has api/types/hooks/utils + components/pages
```

## Backend Setup

```bash
cd backend
source ../.venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
```

Run API:

```bash
uvicorn app.main:app --reload --port 8000
```

Run tests:

```bash
pytest
```

### Backend Environment Variables

Set these in `backend/.env`:

- `DATABASE_URL=sqlite:///./loan_portal.db`
- `JWT_SECRET_KEY=<long-random-secret>`
- `FRONTEND_URL=http://localhost:5173`
- `UPLOAD_DIR=./uploads`
- `RESEND_API_KEY=<optional for real emails>`
- `EMAIL_FROM=<verified sender for resend>`

## Frontend Setup

```bash
cd frontend
npm install
cp .env.example .env
npm run dev
```

### Frontend Environment Variables

- `VITE_API_BASE_URL=http://localhost:8000/api/v1`
- `VITE_GOOGLE_MAPS_API_KEY=<required for places autocomplete>`

## Alembic Migrations

From `backend/`:

```bash
alembic upgrade head
```

An initial migration (`20260207_0001_initial`) is included.

## Docker (EC2 Backend)

```bash
cd backend
cp .env.example .env
docker compose up -d --build
```

This mounts:
- `loan_portal.db` (SQLite persistence)
- `uploads/` (local file storage)

## Vercel (Frontend)

- Import `frontend/` project into Vercel
- Build command: `npm run build`
- Output: `dist`
- Set env vars:
  - `VITE_API_BASE_URL=https://<your-ec2-domain>/api/v1`
  - `VITE_GOOGLE_MAPS_API_KEY=<key>`

## API Surface (high level)

- `POST /api/v1/auth/partner/signup`
- `POST /api/v1/auth/login`
- `POST /api/v1/auth/password/forgot`
- `POST /api/v1/auth/password/reset`
- `POST /api/v1/auth/verify-email`
- `POST /api/v1/auth/borrower/invite/accept`
- `GET /api/v1/partner/dashboard`
- `POST /api/v1/partner/deals`
- `GET /api/v1/admin/kanban`
- `PATCH /api/v1/admin/deals/{deal_id}/stage`
- `POST /api/v1/admin/lenders/import`
- `POST /api/v1/admin/deals/{deal_id}/commission`
- `GET /api/v1/admin/exports/{entity}`

## Demo Credentials

Manual account provisioning is expected for submission.

Add these in your deployed environment before sharing:
- partner demo account
- admin demo account
- borrower account generated by submitting a test deal

## Assumptions and Known Tradeoffs

- SQLite is used intentionally for single-instance EC2 demo scope
- File uploads are stored on EC2 local disk (no S3 in V1)
- Update propagation is manual refresh (no websocket/polling)
- No auth rate-limiting (explicitly deferred)
- API docs exposed only in development mode (`/docs`)
- No CI pipeline in this iteration

## Time Spent

Track your actual time spent before submission.
